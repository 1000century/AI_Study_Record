<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Reranking ë° í‰ê°€ ì‹œê°í™”</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #3498db, #2ecc71);
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-left: 20px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        
        .step {
            background: #f8f9fa;
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
            transition: transform 0.3s ease;
        }
        
        .step:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.2);
        }
        
        .step-number {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            font-size: 0.9em;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            margin: 15px 0;
            overflow-x: auto;
            position: relative;
        }
        
        .code-block::before {
            content: 'ğŸ’» ì½”ë“œ';
            position: absolute;
            top: -10px;
            left: 20px;
            background: #e74c3c;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .metric-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .metric-desc {
            opacity: 0.9;
            font-size: 0.95em;
        }
        
        .flow-diagram {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .flow-item {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
            margin: 10px;
            min-width: 200px;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            position: relative;
        }
        
        .flow-item::after {
            content: 'â†’';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2em;
            color: #3498db;
            font-weight: bold;
        }
        
        .flow-item:last-child::after {
            display: none;
        }
        
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .comparison-table th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        
        .comparison-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .improvement {
            color: #27ae60;
            font-weight: bold;
        }
        
        .decline {
            color: #e74c3c;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .flow-diagram {
                flex-direction: column;
            }
            
            .flow-item::after {
                content: 'â†“';
                right: 50%;
                top: 100%;
                transform: translateX(50%);
            }
            
            .flow-item:last-child::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ RAG Reranking & í‰ê°€ ë©”íŠ¸ë¦­</h1>
            <p>ê²€ìƒ‰-ì¦ê°• ìƒì„± ì‹œìŠ¤í…œì˜ ì¬ìˆœìœ„í™”ì™€ ì„±ëŠ¥ í‰ê°€ ì™„ë²½ ê°€ì´ë“œ</p>
        </div>
        
        <div class="content">
            <!-- 1. Reranking ê°œë… -->
            <div class="section">
                <h2 class="section-title">ğŸ”„ 1. Rerankingì´ë€?</h2>
                
                <div class="highlight">
                    <strong>Reranking</strong>ì€ ì´ˆê¸° ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë” ì •í™•í•œ ê´€ë ¨ì„± ì ìˆ˜ë¡œ ì¬ì •ë ¬í•˜ëŠ” ê³¼ì •ì…ë‹ˆë‹¤.
                </div>
                
                <div class="flow-diagram">
                    <div class="flow-item">
                        <h3>ì´ˆê¸° ê²€ìƒ‰</h3>
                        <p>ë²¡í„° ìœ ì‚¬ë„ë¡œ<br>ë¬¸ì„œ ê²€ìƒ‰</p>
                    </div>
                    <div class="flow-item">
                        <h3>Reranking</h3>
                        <p>CrossEncoderë¡œ<br>ì •ë°€ ì¬í‰ê°€</p>
                    </div>
                    <div class="flow-item">
                        <h3>ìµœì¢… ê²°ê³¼</h3>
                        <p>ê´€ë ¨ì„± ë†’ì€ ìˆœìœ¼ë¡œ<br>ì¬ì •ë ¬</p>
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ’¡</span>
                    <strong>í•µì‹¬ ì•„ì´ë””ì–´:</strong> ë¹ ë¥¸ 1ì°¨ ê²€ìƒ‰ + ì •í™•í•œ 2ì°¨ ì •ë°€í‰ê°€
                </div>
            </div>

            <!-- 2. ì½”ë“œ êµ¬ì¡° ë¶„ì„ -->
            <div class="section">
                <h2 class="section-title">ğŸ”§ 2. Reranking ì½”ë“œ êµ¬ì¡°</h2>
                
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>CrossEncoder ëª¨ë¸ ì´ˆê¸°í™”</strong>
                    <div class="code-block" style="white-space: pre-wrap;">

from sentence_transformers import CrossEncoder

# BGE Reranker ëª¨ë¸ ë¡œë“œ
reranker = CrossEncoder("BAAI/bge-reranker-v2-m3")
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>Reranking í•¨ìˆ˜ ì •ì˜</strong>
                    <div class="code-block" style="white-space: pre-wrap;">
def rerank_documents(query: str, documents: List[str], top_k: int = 5):
    # 1. ì¿¼ë¦¬-ë¬¸ì„œ ìŒ ìƒì„±
    pairs = [(query, doc) for doc in documents]
    
    # 2. ê´€ë ¨ì„± ì ìˆ˜ ê³„ì‚°
    scores = reranker.predict(pairs)
    
    # 3. ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
    doc_scores = list(zip(documents, map(float, scores)))
    doc_scores.sort(key=lambda x: x[1], reverse=True)
    
    return doc_scores[:top_k]  # ìƒìœ„ kê°œ ë°˜í™˜
                    </div>
                </div>
                
                <div class="success">
                    <strong>âœ… í•µì‹¬ í¬ì¸íŠ¸:</strong> CrossEncoderëŠ” ì¿¼ë¦¬ì™€ ë¬¸ì„œë¥¼ í•¨ê»˜ ì…ë ¥ë°›ì•„ ì§ì ‘ì ì¸ ê´€ë ¨ì„±ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
                </div>
            </div>

            <!-- 3. í‰ê°€ ë©”íŠ¸ë¦­ -->
            <div class="section">
                <h2 class="section-title">ğŸ“Š 3. í‰ê°€ ë©”íŠ¸ë¦­ ì„¤ëª…</h2>
                
                <div class="metric-card">
                    <div class="metric-title">ğŸ¯ Hit Rate@k</div>
                    <div class="metric-desc">
                        ìƒìœ„ kê°œ ê²°ê³¼ ì¤‘ì— ì •ë‹µì´ í¬í•¨ëœ ë¹„ìœ¨<br>
                        <strong>ê³µì‹:</strong> (ì •ë‹µ í¬í•¨ ì¿¼ë¦¬ ìˆ˜) / (ì „ì²´ ì¿¼ë¦¬ ìˆ˜)
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-title">ğŸ† MRR (Mean Reciprocal Rank)</div>
                    <div class="metric-desc">
                        ì •ë‹µì´ ë‚˜íƒ€ë‚˜ëŠ” í‰ê· ì ì¸ ì—­ìˆœìœ„<br>
                        <strong>ê³µì‹:</strong> 1/ìˆœìœ„ì˜ í‰ê·  (ë†’ì„ìˆ˜ë¡ ì¢‹ìŒ)
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ’¡</span>
                    <strong>ì˜ˆì‹œ:</strong> ì •ë‹µì´ 3ë²ˆì§¸ì— ìˆë‹¤ë©´ MRR = 1/3 = 0.333
                </div>
            </div>

            <!-- 4. í‰ê°€ ê³¼ì • ìƒì„¸ -->
            <div class="section">
                <h2 class="section-title">ğŸ” 4. í‰ê°€ ê³¼ì • ë‹¨ê³„ë³„ ë¶„ì„</h2>
                
                <div class="step">
                    <span class="step-number">1</span>
                    <strong>ë°ì´í„° ì¤€ë¹„</strong>
                    <div class="code-block" style="white-space: pre-wrap;">
# í‰ê°€ìš© ìƒ˜í”Œ ì¶”ì¶œ
eval_samples = random.sample(list(evaluation_data), 20)

# ê° ìƒ˜í”Œ êµ¬ì¡°:
# {
#   'query': 'ì§ˆë¬¸',
#   'answer': 'ì •ë‹µ',
#   'relevant_docs_metadata': [ê´€ë ¨ë¬¸ì„œì •ë³´]
# }
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <strong>ì›ë³¸ ê²€ìƒ‰ ìˆ˜í–‰</strong>
                    <div class="code-block" style="white-space: pre-wrap;">
# ë²¡í„° ìœ ì‚¬ë„ ê¸°ë°˜ ì´ˆê¸° ê²€ìƒ‰
retrieved_docs = retriever.get_relevant_documents(query)
original_docs = [doc.page_content for doc in retrieved_docs]
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">3</span>
                    <strong>Reranking ì ìš©</strong>
                    <div class="code-block" style="white-space: pre-wrap;">
# CrossEncoderë¡œ ì¬ìˆœìœ„í™”
reranked_results = reranker_func(query, original_docs, top_k=10)
reranked_docs = [doc for doc, _ in reranked_results]
                    </div>
                </div>
                
                <div class="step">
                    <span class="step-number">4</span>
                    <strong>ì„±ëŠ¥ ë¹„êµ í‰ê°€</strong>
                    <div class="code-block" style="white-space: pre-wrap;">
# Hit Rate@k ê³„ì‚°
for k in [1, 3, 5, 10]:
    hit_rate_original = calculate_hit_rate(ground_truth, original_docs, k)
    hit_rate_reranked = calculate_hit_rate(ground_truth, reranked_docs, k)
    
    improvement = hit_rate_reranked - hit_rate_original
                    </div>
                </div>
            </div>

            <!-- 5. Semantic Similarity í‰ê°€ -->
            <div class="section">
                <h2 class="section-title">ğŸ§  5. Semantic Similarity ê¸°ë°˜ í‰ê°€</h2>
                
                <div class="warning">
                    <strong>âš ï¸ ê¸°ì¡´ ë¬¸ì œì :</strong> ë‹¨ìˆœ ë¬¸ìì—´ ë§¤ì¹­ìœ¼ë¡œëŠ” ì˜ë¯¸ì ìœ¼ë¡œ ê°™ì§€ë§Œ í‘œí˜„ì´ ë‹¤ë¥¸ ë‹µë³€ì„ ë†“ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ”¬</span>
                    <strong>ê°œì„ ëœ í‰ê°€ ë°©ë²•</strong>
                    <div class="code-block" style="white-space: pre-wrap;">
def calculate_semantic_hit_rate(ground_truth, retrieved_docs, embeddings_model, threshold=0.7):
    # 1. ì„ë² ë”© ìƒì„±
    gt_embedding = embeddings_model.embed_query(ground_truth)
    doc_embeddings = embeddings_model.embed_documents(retrieved_docs[:k])
    
    # 2. ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
    similarities = cosine_similarity([gt_embedding], doc_embeddings)[0]
    
    # 3. ì„ê³„ê°’ ì´ìƒì´ë©´ Hit
    return 1.0 if max(similarities) >= threshold else 0.0
                    </div>
                </div>
                
                <div class="success">
                    <strong>âœ… ì¥ì :</strong> ì˜ë¯¸ì ìœ¼ë¡œ ìœ ì‚¬í•œ ë‹µë³€ë„ ì˜¬ë°”ë¥´ê²Œ í‰ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>

            <!-- 6. ê²°ê³¼ ë¶„ì„ -->
            <div class="section">
                <h2 class="section-title">ğŸ“ˆ 6. ì„±ëŠ¥ ê°œì„  ë¶„ì„</h2>
                
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>ë©”íŠ¸ë¦­</th>
                            <th>ì›ë³¸ ê²€ìƒ‰</th>
                            <th>Reranking í›„</th>
                            <th>ê°œì„ ë„</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Hit Rate@1</td>
                            <td>0.250</td>
                            <td>0.350</td>
                            <td class="improvement">+40%</td>
                        </tr>
                        <tr>
                            <td>Hit Rate@3</td>
                            <td>0.450</td>
                            <td>0.600</td>
                            <td class="improvement">+33%</td>
                        </tr>
                        <tr>
                            <td>Hit Rate@5</td>
                            <td>0.600</td>
                            <td>0.750</td>
                            <td class="improvement">+25%</td>
                        </tr>
                        <tr>
                            <td>MRR</td>
                            <td>0.380</td>
                            <td>0.520</td>
                            <td class="improvement">+37%</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="step">
                    <span class="step-number">ğŸ“Š</span>
                    <strong>ë¶„ì„ ê²°ê³¼:</strong> Rerankingì´ ëª¨ë“  ë©”íŠ¸ë¦­ì—ì„œ ì¼ê´€ëœ ì„±ëŠ¥ í–¥ìƒì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                </div>
            </div>

            <!-- 7. ì‹¤ì œ ì˜ˆì‹œ -->
            <div class="section">
                <h2 class="section-title">ğŸ” 7. êµ¬ì²´ì  ì˜ˆì‹œ ë¶„ì„</h2>
                
                <div class="step">
                    <span class="step-number">Q</span>
                    <strong>ì§ˆë¬¸:</strong> "ë¶€ì¸ê³¼ í™˜ìì˜ ì£¼í˜¸ì†Œ ì¤‘ ê°€ì¥ í”í•œ ì¦ìƒì€?"
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ“„</span>
                    <strong>ì›ë³¸ ê²€ìƒ‰ 1ìœ„:</strong> "ì‚°ë¶€ì¸ê³¼ ì§„ë£Œ ê°€ì´ë“œë¼ì¸..."
                    <br><small>ìœ ì‚¬ë„: 0.65</small>
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ¯</span>
                    <strong>Reranking 1ìœ„:</strong> "ë¹„ì •ìƒ ìê¶ì¶œí˜ˆì€ ë¶€ì¸ê³¼ í™˜ìì˜..."
                    <br><small>ê´€ë ¨ì„± ì ìˆ˜: 0.89</small>
                </div>
                
                <div class="success">
                    <strong>âœ… ê°œì„  íš¨ê³¼:</strong> ë” êµ¬ì²´ì ì´ê³  ê´€ë ¨ì„± ë†’ì€ ë¬¸ì„œê°€ ìƒìœ„ë¡œ ì˜¬ë¼ì™”ìŠµë‹ˆë‹¤!
                </div>
            </div>

            <!-- 8. í•µì‹¬ ì¸ì‚¬ì´íŠ¸ -->
            <div class="section">
                <h2 class="section-title">ğŸ’¡ 8. í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h2>
                
                <div class="step">
                    <span class="step-number">ğŸš€</span>
                    <strong>Rerankingì˜ íš¨ê³¼</strong>
                    <ul>
                        <li>ë¹ ë¥¸ ë²¡í„° ê²€ìƒ‰ìœ¼ë¡œ í›„ë³´ ë¬¸ì„œ í™•ë³´</li>
                        <li>ì •ë°€í•œ CrossEncoderë¡œ ê´€ë ¨ì„± ì¬í‰ê°€</li>
                        <li>íŠ¹íˆ ìƒìœ„ ë­í‚¹ì—ì„œ í° ê°œì„  íš¨ê³¼</li>
                    </ul>
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ“Š</span>
                    <strong>í‰ê°€ ë©”íŠ¸ë¦­ì˜ ì˜ë¯¸</strong>
                    <ul>
                        <li><strong>Hit Rate@1:</strong> ì²« ë²ˆì§¸ ê²°ê³¼ì˜ ì •í™•ë„</li>
                        <li><strong>Hit Rate@5:</strong> ìƒìœ„ 5ê°œ ì¤‘ ì •ë‹µ í¬í•¨ë¥ </li>
                        <li><strong>MRR:</strong> í‰ê· ì ì¸ ì •ë‹µ ë°œê²¬ ì†ë„</li>
                    </ul>
                </div>
                
                <div class="step">
                    <span class="step-number">ğŸ¯</span>
                    <strong>ì‹¤ë¬´ ì ìš© íŒ</strong>
                    <ul>
                        <li>ì˜ë£Œ/ë²•ë¥  ë“± ì •í™•ì„±ì´ ì¤‘ìš”í•œ ë„ë©”ì¸ì— íš¨ê³¼ì </li>
                        <li>ì´ˆê¸° ê²€ìƒ‰ ê²°ê³¼ê°€ ë§ì„ ë•Œ ë” í° íš¨ê³¼</li>
                        <li>ê³„ì‚° ë¹„ìš©ê³¼ ì„±ëŠ¥ í–¥ìƒì˜ íŠ¸ë ˆì´ë“œì˜¤í”„ ê³ ë ¤</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>