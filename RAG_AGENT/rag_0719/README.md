# RAG Reranking 실험 (2025-07-19)

## 실험 목적
RAG 시스템에서 `CrossEncoder 기반 reranking`을 적용하여 검색 성능을 개선하는 실험

## 실험 환경
- **임베딩 모델**: OpenAI text-embedding-3-small
- **LLM**: Google Gemini 2.0 Flash
- **Reranker**: `BAAI/bge-reranker-v2-m3` (CrossEncoder)
- **데이터베이스**: ChromaDB
- **평가 데이터**: HuggingFace 의료 QA 데이터셋 (5,207개 중 20개 샘플-`s1000secent/0705_rag_dataset`)

## 실험 구조

### 1. Reranking 파이프라인
```
초기 검색 (벡터 유사도) → Reranking (CrossEncoder) → 최종 결과
```

### 2. 평가 메트릭
- **Hit Rate@k**: 상위 k개 결과 중 정답 포함 비율
- **MRR (Mean Reciprocal Rank)**: 정답 순위의 역수 평균
- **Semantic Similarity**: 임베딩 기반 의미적 유사도 (threshold=0.7)

## 주요 결과

### 기본 평가 결과
모든 메트릭에서 성능이 0.000으로 나타남 - 데이터 매칭 방식의 문제로 추정

### Semantic Similarity 분석 (구체적 예시)

#### 예시 1: 부인과 증상 질문
- **질문**: "부인과 환자의 주호소 중 가장 흔한 증상 중 하나는 무엇인가요?"
- **정답**: "비정상 자궁출혈"

> **원본 검색 1위**: 심부전 관련 문서 (유사도: 0.354)  
> **Reranking 1위**: 비정상 자궁출혈 문서 (유사도: 0.523)  
> **개선도**: +0.169 (+47.7%)

#### 예시 2: 뇌하수체 기능저하증
- **질문**: "뇌하수체 기능저하증 성인에게 가장 먼저 나타나는 증상은?"
- **정답**: "Hypogonadism"

> **결과**: 원본과 reranking 모두 동일한 문서 검색 (유사도: 0.353)

#### 예시 3: 수혈 지침
- **질문**: "수혈 시 혈액제제와 혼합 가능한 정맥주입용액은?"
- **정답**: "N/S, 알부민용액, ABO 동형의 혈장, 일부 등장성 정질액"

> **결과**: 원본과 reranking 모두 정확한 문서 검색 (유사도: 0.422)

## 핵심 발견사항

### 1. Reranking 효과
- **정확한 매칭이 중요한 경우**: 극적인 성능 향상 (예시 1)
- **이미 정확한 경우**: 성능 유지
- **의미적 유사도**: 평균적으로 더 관련성 높은 문서 상위 배치

### 2. 평가 방식의 한계
- 단순 문자열 매칭으로는 reranking 효과 측정 한계
- Semantic similarity 기반 평가가 더 의미있는 결과 제공
- 실제 의료 도메인에서는 정확한 문서 매칭이 중요

### 3. 실무 적용 인사이트
- **효과적인 케이스**: 초기 검색이 부정확할 때 큰 개선
- **성능 유지**: 이미 좋은 검색 결과는 품질 유지
- **도메인 특성**: 의료/법률 등 정확성이 중요한 분야에 유용

## 결론
CrossEncoder 기반 reranking이 RAG 시스템의 검색 품질을 개선하는 것을 확인했으나, 평가 데이터셋의 매칭 방식 개선이 필요함.  
실제 사례 분석에서는 의미적으로 더 관련성 높은 문서가 상위로 올라오는 효과를 확인.

## 파일 구조
- `0719.ipynb`: 실험 코드 및 결과
- `reranking_evaluation_guide.html`: 시각화된 평가 가이드
- `chroma_db/`: 벡터 데이터베이스